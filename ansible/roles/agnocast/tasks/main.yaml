- name: Install linux headers for the running kernel
  ansible.builtin.apt:
    name: linux-headers-{{ ansible_kernel }}
    state: present
  become: true

# TODO(rej55, sykwer): IPv6 support
- name: Check if IPv6 sysctl configuration exists
  ansible.builtin.stat:
    path: /proc/sys/net/ipv6/conf/all/disable_ipv6
  register: ipv6_config_stat
  become: true

- name: Temporarily disable IPv6 if it is enabled
  ansible.posix.sysctl:
    name: "{{ item }}"
    value: 1
    sysctl_set: true
    state: present
  loop:
    - net.ipv6.conf.all.disable_ipv6
    - net.ipv6.conf.default.disable_ipv6
  when: ipv6_config_stat.stat.exists
  become: true

- name: Add agnocast PPA repository while IPv6 is disabled
  ansible.builtin.apt_repository:
    repo: ppa:t4-system-software/agnocast
    state: present
    update_cache: false
  become: true

- name: Restore IPv6 to enabled state if it was originally configured
  ansible.posix.sysctl:
    name: "{{ item }}"
    value: 0
    sysctl_set: true
    state: present
  loop:
    - net.ipv6.conf.all.disable_ipv6
    - net.ipv6.conf.default.disable_ipv6
  when: ipv6_config_stat.stat.exists
  become: true

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
  become: true

- name: Install {{ agnocast_heaphook_package }}
  ansible.builtin.apt:
    name: "{{ agnocast_heaphook_package }}"
    state: present
  become: true

- name: Check if agnocast-kmod is installed in dkms with version v{{ agnocast_version }}
  ansible.builtin.shell: dkms status | grep agnocast | grep {{ agnocast_version }} # noqa: risky-shell-pipe
  register: agnocast_dkms_status
  failed_when: false
  changed_when: false

- name: Purge agnocast-kmod if not found in dkms for version v{{ agnocast_version }}
  ansible.builtin.apt:
    name: "{{ agnocast_kmod_package }}"
    state: absent
  become: true
  when: agnocast_dkms_status.rc != 0

- name: Install agnocast-kmod if not found in dkms for version v{{ agnocast_version }}
  ansible.builtin.apt:
    name: "{{ agnocast_kmod_package }}"
    state: present
  become: true
  when: agnocast_dkms_status.rc != 0

- name: Ensure agnocast module is loaded at boot via modules-load.d
  ansible.builtin.copy:
    dest: /etc/modules-load.d/agnocast.conf
    content: "agnocast\n"
    owner: root
    group: root
    mode: "0644"
  become: true
